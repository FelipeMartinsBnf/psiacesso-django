{% extends 'base.html' %}
{% load static %}

{% block title %}Minha Disponibilidade{% endblock %}

{# Bloco para carregar CSS específico desta página #}
{% block extra_css %}
    <link rel="stylesheet" href="{% static 'disponibilidade.css' %}">
{% endblock %}

{% block content %}
<div class="agenda-container">
    <div class="agenda-header">
        <h2>Minha Disponibilidade</h2>
        <p>Clique nos horários abaixo para definir quando você poderá atender seus pacientes.</p>
    </div>

    <div class="agenda-card">
        <form method="post" id="agenda-form">
            {% csrf_token %}
            {# O campo oculto que armazenará o JSON final #}
            {{ form.horarios_selecionados }}

            <div class="agenda-grid">
                <div class="grid-header"></div>
                
                {% for dia_num, dia_nome in dias_semana %}
                    <div class="grid-header">{{ dia_nome }}</div>
                {% endfor %}

                {% for hora in horarios_grade %}
                    <div class="grid-time-label">{{ hora|time:"H:i" }}</div>
                    
                    {% for dia_num, dia_nome in dias_semana %}
                        {% with chave_horario=dia_num|stringformat:"i"|add:","|add:hora|time:"H:i:s" %}
                            {% if chave_horario in horarios_selecionados_set %}
                                <div class="grid-cell selected"
                                     data-dia="{{ dia_num }}"
                                     data-hora="{{ hora|time:"H:i:s" }}">
                                    Disponível
                                </div>
                            {% else %}
                                <div class="grid-cell"
                                     data-dia="{{ dia_num }}"
                                     data-hora="{{ hora|time:"H:i:s" }}">
                                </div>
                            {% endif %}
                        {% endwith %}
                    {% endfor %}
                {% endfor %}
            </div>

            <div class="submit-container">
                <button type="submit" class="submit-btn">
                    Salvar Agenda
                </button>
            </div>
        </form>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const grid = document.querySelector('.agenda-grid');
        const form = document.getElementById('agenda-form');
        const hiddenInput = document.getElementById('id_horarios_selecionados');

        // 1. Manipula o clique visualmente
        grid.addEventListener('click', function(e) {
            const cell = e.target.closest('.grid-cell');
            if (cell) {
                cell.classList.toggle('selected');
                cell.innerText = cell.classList.contains('selected') ? 'Disponível' : '';
            }
        });

        // 2. Prepara os dados antes de enviar o form
        form.addEventListener('submit', function(e) {
            const selectedCells = document.querySelectorAll('.grid-cell.selected');
            let horariosData = [];

            selectedCells.forEach(cell => {
                horariosData.push({
                    dia: cell.dataset.dia,
                    hora: cell.dataset.hora
                });
            });

            hiddenInput.value = JSON.stringify(horariosData);
        });
    });
</script>
{% endblock %}