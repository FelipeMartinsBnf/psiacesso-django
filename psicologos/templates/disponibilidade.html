{% extends 'base.html' %}
{% load static %}

{% block title %}Minha Disponibilidade{% endblock %}

{# Bloco para carregar CSS específico desta página #}
{% block extra_css %}
<link rel="stylesheet" href="{% static 'disponibilidade.css' %}">
{% endblock %}

{% block content %}
<div class="agenda-container">
    <div class="agenda-header">
        <h2>Minha Disponibilidade</h2>
        <p>Clique nos horários abaixo para definir quando você poderá atender seus pacientes.</p>
    </div>

    <div class="agenda-card">
        <form method="post" id="agenda-form">
            {% csrf_token %}
            {# O campo oculto que armazenará o JSON final #}
            {{ form.horarios_selecionados }}

            <div class="agenda-grid">
                <div class="grid-header"></div>

                {% for dia_num, dia_nome in dias_semana %}
                <div class="grid-header">{{ dia_nome }}</div>
                {% endfor %}

                {% for hora in horarios_grade %}

                <div class="grid-time-label">{{ hora|time:"H:i" }}</div>

                {% for dia_num, dia_nome in dias_semana %}

                {% comment %}
                Passo A: Formata a 'hora' para string PRIMEIRO
                {% endcomment %}
                {% with hora_formatada=hora|time:"H:i:s" %}

                {% comment %}
                Passo B: Cria a chave de comparação (ex: "4,07:00:00")
                {% endcomment %}
                {% with chave_horario=dia_num|stringformat:"i"|add:","|add:hora_formatada %}

                {% comment %}
                Passo C: Compara a chave (string) com o set (de strings)
                {% endcomment %}
                {% if chave_horario in horarios_selecionados_set %}
                <div class="grid-cell selected" data-dia="{{ dia_num }}" data-hora="{{ hora_formatada }}">
                    Ativo
                </div>
                {% else %}
                <div class="grid-cell" data-dia="{{ dia_num }}" data-hora="{{ hora_formatada }}">
                </div>
                {% endif %}

                {% endwith %} {% endwith %} {% endfor %} {% endfor %}
            </div>
            <div class="submit-container">
                <button type="submit" class="submit-btn">
                    Salvar Agenda
                </button>
            </div>
        </form>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const grid = document.querySelector('.agenda-grid');
        const form = document.getElementById('agenda-form');
        const hiddenInput = document.getElementById('id_horarios_selecionados');

        // --- LÓGICA DE SELEÇÃO COM DRAG ---

        let isDragging = false;
        let selectionMode = 'select'; // Guarda a ação (selecionar ou deselecionar)

        // 1. Quando o mouse é PRESSIONADO (início do drag)
        grid.addEventListener('mousedown', function (e) {
            // Só age se for uma célula de horário
            if (!e.target.classList.contains('grid-cell')) {
                return;
            }

            // Previne o comportamento padrão do navegador (como arrastar texto)
            e.preventDefault();

            isDragging = true;
            const cell = e.target;

            // Define o MODO da seleção:
            // Se a primeira célula clicada JÁ ESTÁ selecionada,
            // o modo será "deselecionar".
            if (cell.classList.contains('selected')) {
                selectionMode = 'deselect';
                cell.classList.remove('selected');
                cell.innerText = '';
            } else {
                // Se for uma célula nova, o modo será "selecionar".
                selectionMode = 'select';
                cell.classList.add('selected');
                cell.innerText = 'Ativo';
            }
        });

        // 2. Quando o mouse PASSA POR CIMA (durante o drag)
        grid.addEventListener('mouseover', function (e) {
            // Só age se o botão do mouse estiver pressionado (isDragging)
            if (!isDragging) {
                return;
            }

            // Só age se for uma célula de horário
            if (!e.target.classList.contains('grid-cell')) {
                return;
            }

            const cell = e.target;

            // Aplica o modo definido no mousedown
            if (selectionMode === 'select') {
                cell.classList.add('selected');
                cell.innerText = 'Ativo';
            } else {
                cell.classList.remove('selected');
                cell.innerText = '';
            }
        });

        // 3. Quando o mouse é SOLTO (fim do drag)
        // Usamos 'window' para garantir que o evento seja pego
        // mesmo que o usuário solte o mouse fora da grade.
        window.addEventListener('mouseup', function (e) {
            isDragging = false;
        });

        // --- FIM DA LÓGICA DE SELEÇÃO ---


        // 4. Lógica de envio do formulário (IDÊNTICA A ANTES)
        // Esta parte não precisa mudar, pois ela só se importa
        // com o resultado final (quais células TÊM a classe .selected).
        form.addEventListener('submit', function (e) {
            const selectedCells = document.querySelectorAll('.grid-cell.selected');

            const horariosData = [];
            selectedCells.forEach(function (cell) {
                horariosData.push({
                    dia: cell.dataset.dia,
                    hora: cell.dataset.hora
                });
            });

            hiddenInput.value = JSON.stringify(horariosData);
        });
    });
</script>
{% endblock %}